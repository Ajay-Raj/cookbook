<!doctype html>
<html lang=en>
<head>
<title>Screen Grabber Iframe R3</title>
<meta charset=utf-8>
<meta name=author content='Theo Armour'>
</head>
<body>
<script>
// copyright (c) 2014 Jaanga authors ~ MIT License

// add html2canvas ability?

// vars in functions that we might want to be global for debugging


	var optionsSize = ['1024 x 1024','1024 x 768','1024 x 512','800 x 600','640 x 480','600 x 600','512 x 512','512 x 256', 
		'384 x 384','320 x 240','256 x 256', '128 x 128', '64 x 64'];
	var size;
	var output;
	var canvas;

	var img, imgHeight, imgWidth, imgScale1 = 1, imgScale2 = 0.75, imgScale3 = 0.5, imgScale4 = 0.25;
	var fname, txt1, txt2, txt3, txt4;

	init();

	function init() {
		document.body.style.cssText = 'font: bold 12pt monospace; ';

		var info = document.body.appendChild( document.createElement( 'div' ) );

		info.innerHTML =
			'<a href="" ><h1 style=margin:0; >' + document.title + ' </h1></a>' +
			'<p>' +
				'<input type=file id=inpFile onchange=openFile() >' +
				'Select a size <select id=selSize onchange=updateSize() ></select> ' +
				'width: <input type=number id=sizeWidth style=width:50px; min=1 /> ' +
				'height: <input type=number id=sizeHeight style=width:50px; min=1 /> ~ ' +
				'<a href=JavaScript:grabIt(); >Grab It</a> ' +
				'<a href=JavaScript:saveIt(); >Save it</a> ' +

	/*

				'<a href=JavaScript:seconds3grabIt(); >Grab It in 3 Seconds</a> ' +
				
				'<a href=JavaScript:saveIt(canvas1,txt1); >Save 1</a> ' +
				'<a href=JavaScript:saveIt(canvas2,txt2); >Save 2</a> ' +
				'<a href=JavaScript:saveIt(canvas3,txt3); >Save 3</a> ' +
				'<a href=JavaScript:saveIt(canvas4,txt4); >Save 4</a> &nbsp; ' +
				
				'Frame size: ' +
				'<select id=selLeft onchange="changeFrame( this.selectedIndex );" >' +
					'<option>512x512 - 384x384 - 256x256 - 128x128 </option>' +
					'<option>640x480 - 480x360 - 320x240 - 240x180</option>' +
					'<option>800x600 - 600x450 - 400x300 - 200x150</option>' +
				'</select> ' +
				'<a href=JavaScript:doIt(); >do it</a>' +
	*/
			'</p>' +
		'';


		for (var i = 0,len = optionsSize.length; i < len; i++) {
			opt = selSize.appendChild( document.createElement( 'option' ) );
			opt.text = optionsSize[ i ];
		} 
		selSize.selectedIndex = 4;
		updateSize();

/*
		var ifr = document.body.appendChild( document.createElement( 'iframe' ) );
		ifr.src = '../grab-test.html';

		var canvas1 = document.body.appendChild( document.createElement( 'canvas' ) );
		var canvas2 = document.body.appendChild( document.createElement( 'canvas' ) );
		var canvas3 = document.body.appendChild( document.createElement( 'canvas' ) );
		var canvas4 = document.body.appendChild( document.createElement( 'canvas' ) );

		canvas1.style.cssText = canvas2.style.cssText = canvas3.style.cssText = canvas4.style.cssText = 'border: 2px #000 solid; margin: 0 50px;';

		canvas1.height = canvas1.width = imgHeight = imgWidth = ifr.height = ifr.width = 512;
		canvas2.height = canvas2.width = 384;
		canvas3.height = canvas3.width = 256;
		canvas4.height = canvas4.width = 128;

		var context1 = canvas1.getContext('2d',{preserveDrawingBuffer: true});
		var context2 = canvas2.getContext('2d');
		var context3 = canvas3.getContext('2d');
		var context4 = canvas4.getContext('2d');

		changeFrame( 1 );
*/

	}

	function updateSize() {
		size = optionsSize[ selSize.selectedIndex ];
		width = parseInt( size.substr( 0, size.indexOf(' x ') ), 10 );
		height = parseInt( size.substr( size.indexOf(' x ') + 3 ), 10);

		sizeWidth.value = width;
		sizeHeight.value = height;

		if ( output ) {
			addIframe( output )
		}
console.log( size, width, height );
	}

	function addIframe( contents ) {

		var iframes = document.getElementsByTagName( 'iframe' ) ;

		for ( var i = 0, len = iframes.length; i < len; i++ ) {

			iframes[0].parentNode.removeChild( iframes[ 0 ] );

		}

		var canvases = document.getElementsByTagName( 'canvas' ) ;

		for ( var i = 0, len = canvases.length; i < len; i++ ) {

			canvases[0].parentNode.removeChild( canvases[ 0 ] );

		}

		ifr = document.body.appendChild( document.createElement( 'iframe' ) );
		ifr.width = sizeWidth.value; // window.innerWidth;
		ifr.height = sizeHeight.value; //window.innerHeight;
		ifr.style.borderWidth = '1px';
		ifr.srcdoc = contents;


		canvas = document.body.appendChild( document.createElement( 'canvas' ) );
		canvas.style.cssText = 'border: 2px #000 solid; margin: 0 10px;';
		canvas.width = ifr.width;
		canvas.height = ifr.height;
		context = canvas.getContext( '2d' );
	}

	function openFile() {

		var iframes = document.getElementsByTagName( 'iframe' ) ;

		for ( var i = 0, len = iframes.length; i < len; i++ ) {

			iframes[0].parentNode.removeChild( iframes[ 0 ] );

		}

		var canvases = document.getElementsByTagName( 'canvas' ) ;

		for ( var i = 0, len = canvases.length; i < len; i++ ) {

			canvases[0].parentNode.removeChild( canvases[ 0 ] );

		}

		file = inpFile.files[ 0 ];

		var reader = new FileReader();

		reader.onload = function ( event ) {

			output = reader.result;
/*
			re = /<\/script>/;
			mat = output.match( re );
// console.log( mat );
			str = '\<\/script>\n' +
			'\<script src=http://mrdoob.github.io/three.js/examples/js/effects/AsciiEffect.js >\<\/script>\n' +
			'\<script src=http://mrdoob.github.io/three.js/examples/js/renderers/Projector.js >\<\/script>\n' +
			'\<script src=http://mrdoob.github.io/three.js/examples/js/renderers/CanvasRenderer.js >\<\/script>\n' ;
			output = output.replace( re, str );
*/

			re = /antialias: true/gi;
			mat = output.match( re );
console.log( mat );
			str = 'antialias: true, preserveDrawingBuffer: true' ;

			output = output.replace( re, str );

/*
			re = /document.body.appendChild(.*?)renderer.domElement(.*?)\);/gi;
			mat = output.match( re );
//console.log( mat );
			str = 'effect = new THREE.AsciiEffect( renderer );\n' +
				'effect.setSize( window.innerWidth, window.innerHeight ); \n' +
				'document.body.appendChild( effect.domElement ); \n' ;
			output = output.replace( re, str );

			re = /renderer.render(.*?)\);/gi;
			mat = output.match( re );
//console.log( mat );
			str = 'effect.render( scene, camera );' ;
			output = output.replace( re, str );
*/

			addIframe( output ) ;

		};

		reader.readAsText( file );
	}


// reports true but doesn't work
	function doIt() {

		app = ifr.contentWindow;
		THREE = app.THREE;
		renderer = app.renderer;
		scene = app.scene;
		camera = app.camera;
		controls = app.controls;
		material = app.material;


//		renderer = new THREE.WebGLRenderer( { alpha: 1, antialias: true, clearColor: 0xffffff, preserveDrawingBuffer: true }  );
//		renderer.setSize( ifr.contentWindow.innerWidth, ifr.contentWindow.innerHeight );
//		ifr.contentDocument.appendChild( renderer.domElement );

		renderer.preserveDrawingBuffer = true;
		console.log( scene, renderer.preserveDrawingBuffer );
	}

	function loadIt( inpFile ) {

		if ( !inpFile.files ) return;

	//	ifr.src = inpFile.files[0].name;

		fname =  inpFile.files[0].name;
		var index = 1 + fname.lastIndexOf('/');
		fname = fname.substring( index, fname.length - 5) ;

//		if ( extension === 'html' ) {

			var reader = new FileReader();
			reader.addEventListener( 'load', function ( event ) {

				var contents = reader.result;
				ifr.onload = function() {

//					JAFO.updateIframe( V3PL.permalinks );
//					JAFO.switchType( permalink, contents, scale );

				};

				ifr.srcdoc = contents;

			}, false );

			reader.readAsText( inpFile.files[0] );
//		}
	}

	function grabIt() {
		img = new Image();
		img.onload = function() {
			context.setTransform(1,0,0,1,0,0);
			context.clearRect ( 0, 0, imgWidth, imgHeight);
			context.scale( imgScale1, imgScale1 );
			context.drawImage( img, 0, 0 );

		};

		img.src = ifr.contentWindow.renderer.domElement.toDataURL('image/png');
	}

	function seconds3grabIt() {
		setTimeout(function(){
			//img.src = ifr.contentWindow.renderer.domElement.toDataURL('image/png');
			grabIt()
			console.log( 'got it');
		},3000);
	}

	function saveIt ( ) {
		var blob = new Blob( [ img.src ], { type: 'image/png' } );

		var a = document.createElement( 'a' );

		a.href = URL.createObjectURL( blob );
		a.download = file.name + ' ' + size + '.png';
		a.click();

		delete a;
/*
		canvas.toBlob( function( blob ) {
			saveAs( blob, file.name + ' ' + size );
		});
*/
	}

	function changeFrame( index ) {
		if ( index === 0 )  {
			canvas1.width = ifr.width = imgWidth = canvas1.height = ifr.height = imgHeight = 512;

			canvas2.height = canvas2.width = 384;
			canvas3.height = canvas3.width = 256;
			canvas4.height = canvas4.width = 128;

			imgScale4 = 0.25;

			txt1 = '-screen-grab-512x512.png';
			txt2 = '-screen-grab-384x384.png';
			txt3 = '-screen-grab-256x256.png';
			txt4 = '-screen-grab-128x128.png';

		} else if ( index === 1 ) {
			canvas1.width = imgWidth = ifr.width = 640;
			canvas1.height = imgHeight = ifr.height = 480;

			canvas2.width = 480;
			canvas2.height = 360;

			canvas3.width = 320;
			canvas3.height = 240;

			canvas4.width = 240;
			canvas4.height = 180;

			imgScale4 = 0.375;

			txt1 = '-screen-grab-640x480.png';
			txt2 = '-screen-grab-480x360.png';
			txt3 = '-screen-grab-320x240.png';
			txt4 = '-screen-grab-240x180.png';

		} else if ( index === 2 ) {
			canvas1.width = imgWidth = ifr.width = 800;
			canvas1.height = imgHeight = ifr.height = 600;

			canvas2.width = 600;
			canvas2.height = 450;

			canvas3.width = 400;
			canvas3.height = 300;

			canvas4.width = 200;
			canvas4.height = 150;

			imgScale4 = 0.25;

			txt1 = '-screenGrab-800x600.png';
			txt2 = '-screenGrab-600x450.png';
			txt3 = '-screenGrab-400x300.png';
			txt3 = '-screenGrab-200x150.png';
		}
	}

</script>
</body>
</html>